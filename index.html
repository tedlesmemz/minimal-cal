<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dark Day Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      margin: 0;
      padding: 8px;
      font-family: sans-serif;
      background: #282828;
      color: white;
      font-size: 16px;
      line-height: 1.4;
    }
    .event {
      margin-bottom: 4px;
    }
    .time {
      font-weight: bold;
      margin-right: 6px;
    }
    .title {
      display: inline;
    }
    .no-events {
      text-align: center;
      margin-top: 20px;
      color: #bbb;
    }
  </style>
</head>
<body>
  <div id="events">Loading today's eventsâ€¦</div>
  <script>
    // Your public ICS URL:
    const ICS_URL = 'https://calendar.google.com/calendar/ical/teddycapobianco%40gmail.com/public/basic.ics';

    // Use CORS proxy to bypass CORS restrictions
    const PROXY_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(ICS_URL);

    function parseICal(text) {
      const lines = text.split(/\r?\n/);
      const events = [];
      let vevent = null;
      lines.forEach(line => {
        if (line === 'BEGIN:VEVENT') {
          vevent = {};
        } else if (line === 'END:VEVENT') {
          events.push(vevent);
          vevent = null;
        } else if (vevent) {
          const [key, ...rest] = line.split(':');
          const value = rest.join(':');
          vevent[key] = value;
        }
      });
      return events;
    }

    function formatTime(dt) {
      if (!dt) return '';
      const date = new Date(dt);
      return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }

    fetch(PROXY_URL)
      .then(res => res.text())
      .then(text => {
        const all = parseICal(text);
        const now = new Date();

        const todayEvents = all.filter(e => {
          if (!e['DTSTART']) return false;
          let dtString = e['DTSTART'];
          let eventDate;

          if (/^\d{8}T\d{6}Z?$/.test(dtString)) {
            if (dtString.endsWith('Z')) {
              eventDate = new Date(dtString);
            } else {
              const isoStr = dtString.slice(0,4) + '-' + dtString.slice(4,6) + '-' + dtString.slice(6,8) + 'T' + dtString.slice(9,11) + ':' + dtString.slice(11,13) + ':' + dtString.slice(13,15);
              eventDate = new Date(isoStr);
            }
          } else if (/^\d{8}$/.test(dtString)) {
            eventDate = new Date(dtString.slice(0,4) + '-' + dtString.slice(4,6) + '-' + dtString.slice(6,8));
          } else {
            return false;
          }

          return eventDate.getFullYear() === now.getFullYear()
            && eventDate.getMonth() === now.getMonth()
            && eventDate.getDate() === now.getDate();
        });

        todayEvents.sort((a, b) => (a.DTSTART > b.DTSTART ? 1 : -1));

        const el = document.getElementById('events');
        if (todayEvents.length === 0) {
          el.textContent = "No events today.";
        } else {
          el.innerHTML = '';
          todayEvents.forEach(evt => {
            const div = document.createElement('div');
            div.className = 'event';
            const timeSpan = document.createElement('span');
            timeSpan.className = 'time';
            timeSpan.textContent = formatTime(evt['DTSTART']);
            const titleSpan = document.createElement('span');
            titleSpan.className = 'title';
            titleSpan.textContent = evt['SUMMARY'] || '(No title)';
            div.appendChild(timeSpan);
            div.appendChild(titleSpan);
            el.appendChild(div);
          });
        }
      })
      .catch(err => {
        document.getElementById('events').textContent = 'Error loading calendar.';
        console.error(err);
      });
  </script>
</body>
</html>
